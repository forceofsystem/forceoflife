---
title: 'vi 和 vim 你不知道的那些事（一）'
date: 2024-07-29T13:46:30+08:00
draft: false
toc: true
tags:
- vim
- 计算机
---

<!--more-->

国内的很多 vim/neovim 用户都是从 TheCW 的视频中了解 vim 和 neovim 的，CW 的视频主要是以程序员的角度来介绍如何使用 vim，内容也更多聚焦在如何用插件来达到更方便的操作。但很多插件提供的操作都是 vim 本身所具有的，并且在 CW 的视频中虽然介绍了按键映射，但是对 vim 本身按键的缺省功能并没有涉及，使得很多 vim 的用户在并不知情的情况下丧失了很多强大的功能。此外，随着 neovim 的发展，出现了越来越多的 neovim 发行版，这进一步降低了 vim 的使用难度，但也丢掉了许多 vim 的特性，在将 vim 作为一个 ide 使用之前，我认为有必要了解 vim 作为文本编辑器的功能和操作，也为更好地使用 vim 打下基础。所以，我打算写一系列博客来介绍 vi/vim 缺省的功能和操作，希望能够帮助到更多的 vim 用户。

注：本文主要内容来自 [《Learning the vi and Vim Editors》](https://www.oreilly.com/library/view/learning-the-vi/9780596529833/)。

再注：本文的形式更偏向于 cheat sheet，并不会涉及过多历史性的问题，如 ex 和 vi、vim 的关系等。对于基本操作，只会给出按键和解释，并不会有完整的上下文。如果想要了解更多内容，可以参考上一条注。

## 移动操作

`~`: 将当前光标下字符的大小写改为相反的状态并向右移动一列。

vim 会将最近 9 次的删除动作保存在 9 个编号的删除寄存器中，假设要恢复 3 号寄存器的内容，输入`"3g`。

> 这只对被整行删除的内容有用，如果只是删除一部分，那么被删除的内容是不会被保存在寄存器中的。

`x`：删除当前光标下的字符。

`xp`：可以用这个命令来交换两个字母的位置，这对会把 `main` 打成 `mian` 的 C 语言初学者可谓是一大福音。

`J`：将光标放在一行的任何位置的情况下，会将该行与下一行合并（用空格分隔）

`z<cr>`：将光标移到屏幕顶端并滚动屏幕

`z.`：将光标移动到屏幕中心并滚动屏幕

`z-`：将光标移动到屏幕底部并滚动屏幕

> z 前面可以加行号，即将对应行移动到对应位置。

`H`：移动到屏幕顶端的行

`M`：移动到屏幕中间的行

`L`：移动到屏幕底端的行

> H 和 L 可以跟数字，移动到距对应位置 x 行的地方。

`+`：移动到下一行的第一个字符处

`-`：移动到上一行的第一个字符处

`n|`：移动到当前行的第 n 列处

`(`：移动到当前句子的开头

`)`：移动到下一个句子的开头

`{`：移动到当前段的开头

`}`：移动到下一段的开头

`[[`：移动到当前节的开头

`]]`：移动到下一节的开头

> vim 会寻找标点符号来判断句子的结束，当这些标点符号后至少有两个空格或作为一行的最后一个非空格字符时，这句话被视为结束。
>
> 段落是下一个空白行前的文本。
>
> 还有些与不常见的宏有关。

`/` 或 `？` 可以与删除、修改文本的命令连用

`t`：搜索并将光标移到本行中下一次出现搜索目标的前一个字符处

`T`：搜索并将光标移到本行中上一次出现搜索目标的后一个字符处

`,`：重复上一个搜索命令，方向相反

`C-g` 会显示文件信息

`G`：接受数字为参数，移动到目标行

``：

- 未编辑：上一次使用 G 的位置；
- 已编辑：回到编辑位置；
- 搜索：上一次搜索位置

`''`：与上同，但是会回到对应行的开头

```
# 在第 n 行打开文件
vim +n file
# 在最后一行打开文件
vim + file
# 在第一次出现 pattern 的行首打开文件
# 可以使用 \ 和 "" 来帮助搜索
vim +/pattern file
```

`vi - R` 和 `view` 会以只读模式打开文件

`vi -r file` 会恢复保存在编辑寄存器的文件

复制的文本（y）会保存在用字母标识的寄存器中，可以访问任意一个

`"<registerName>(operation)`：将对应操作的结果放到指定寄存器中

> 使用大写字母指定寄存器时，会将内容附加到当前寄存器内容后。

`mx`：将当前位置标记为 x，x 为任何字符

`'x`：将光标移动到标记 x 所在行的第一个字符

``x`：将光标移动到以 x 标记的字符

> 标记只在当前会话中有效。

## Ex 操作

### 基本操作

| Full name | Abbreviation | Meaning |
| --------- | ------------ | ------- |
| delete    | d            | 删除行  |
| move      | m            | 移动行  |
| copy      | co           | 复制行  |
|           | t            | 同上    |

> move 和 copy 指令需要额外指定目标行号。

### 指定位置

在 ex 模式中，`.` 表示当前行，`$` 表示文件的最后一行，`%`表示文件中的每一行。还可以用数字直接指定行/范围，如`:2d`，`:1,3d`；或是用 +，- 来表示相对关系（0 表示开头）。

> `:/pattern/=` 会列出 pattern 第一次出现的行号。

此外，还可以用搜索模式来指定行地址：

```
# 删除下一个包含 pattern 的行
:/pattern/d
# 删除下一个包含 pattern 的行的下一行
:/pattern/+d / :/pattern/+1d
# 从第一个包含 pattern1 的行删除到第一个包含 pattern2 的行
:/pattern1/,/pattern2/d
# 将从当前行到第一个包含 pattern 的行之间的文本放到 23 行之后
:./,pattern/m23
```

> ex 命令都是对行操作，所以 `:.,/pattern/d` 会删除当前行到第一个包含 pattern 行之间所有的**行**，而 vim 的 d 操作只是删除内容，所以 `d/pattern` 只会删除当前光标到第一个 pattern 前的所有内容。

默认情况下，ex 模式下的相对行运算是以当前行为基准的，即 `+5` 等价于 `.+5`，所以类似的命令可能是无效的：`:100,+5p`，如果当前行 + 5 的结果仍小于 100，该命令无效。要想达到类似管道的效果，需要使用 `;`，即 `:100;+5p`，等价于 `:100,105p`。这个方法在搜索模式下很好用。

### 全局操作与替换

在 ex 模式下，`g` 代表全局命令，`s` 代表替换（substitute）。

在 ex 中，使用 `|` 来**分隔**指令，而不是**管道**，就像 shell 中的 `;` 一样。

在保存文件时，可以使用指定行号的方式保存一部分内容到一个文件中：`:230,$w newfile`；也可以将文件内容附加到对应文件中：`:1,10w newFileName | 340,$w >>newFileName`。

使用 `r` 命令来将外部文本读入到当前光标的下一行，可以指定行号来插入到指定行的下一行。同样的，我们可以进行很多高级操作：

```
:$r /home/patrickz/data
:0r /home/patrickz/data
:/pattern/r /home/patrickz/data
```

ex 可以打开多个文件，并用 `:n` 前往下一个文件，用 `:rewind`（`:rew`）重置回第一个，用 `:last` 移动到最后一个，用 `:args` 可以查看状态行。

vi 会用符号 `%` 代表当前文件的文件名，`#` 来代表上一个 buffer。

替换命令的语法：

```
:s/old/new/
:s/old/new/g
```

上面的 `g` 会把**这一行**中所有的 `old` 替换为 `new`，`:g` 开头才会针对全部文件。可以在 `s` 的前面加上数字来表示范围，包括 `%` 来代表当前文件。

可以用 `:e!` 来读出上一个版本的缓冲区内容。可以在命令后加 `c` 来使得每一次替换前都会有一个确认环节。如果想进行模式匹配的替换，需要使用下面的命令：

```
:g/pattern/s/old/new/g
```

对于如下文本，我们可以采用 `:g/<keymap>/s/Esc/ESC/g` 来将以 keycap 开头行的所有 `Esc` 替换为 `ESC`：

```
<keycap>EscEsc</keycap>
<keycap>EscEsc</keycap>
<keycap>EscEsc</keycap>
<keycap>EscEsc</keycap>
Esc
Esc
```

> 命令解释：
>
> - `:g` ：ex 命令，其后跟着的命令能够对所有行生效
> - `/<keycap>` ：搜索以 `<keycap>` 开头的行
> - `s/Esc/ESC/g` ：将一行中所有的 `Esc` 替换为 `ESC`
>
> 如果只想替换每行中的第一个 `Esc`，不需要加 `g`，即 `:g/<keymap>/s/Esc/ESC/`

如果用于搜索行的模式与用于替换的模式相同，则不需要重复输入，即：`:g/string/s//new/g`。

> 下面两个命令是等价的：
>
> - `:g/editer/s//editor/g`
> - `:%s/editer/editor/g`

正则表达式（搜索中的元字符）：

- `.` ：匹配除换行符外的任一字符，如 `p.p` 可以匹配 `pep`、`pip`、`p&p`；

- `*` ：匹配出位于此符号前的单一字符（出现一次或多次，贪婪匹配），如 `bugs*` 可以匹配出 `bugss`、 `bugs` 或 `bug`。

  > `:s/End.*/End/` 会将所有在 End 后面的字符删掉（将该行位于 End 后的文本替换成没有文本）。

- `^` ：当 `^` 位于开头时，其后的正则表达式必须位于一行的开头；当 `^` 位于其他位置时，其代表本意。

- `$` ：当 `$` 位于正则表达式的结尾时，其前面的正则表达式必须位于一行的结尾；当位于其他位置时，其代表本意。

- `\` ：转义字符。

- `[ ]` ：匹配出方括号里的任何一个字符，如 `[AB]` 匹配出 `A` 或 `B`，而 `p[aeiou]t` 可匹配出 `pat`、`pet`、`pit`、`pot`、`put`，可用连字符来表示范围，如 `[A-Z]` 可表示 A 到 Z 间的所有大写字母，`[0-9]` 会匹配出任何 0 到 9 间的任何数字，`[ ]` 可以包括任何混合字符。

  > 方括号中 `\`、`-`、`]` 需要转义字符。

- `\( \)` ：这个表达式会将 `\(` 和 `\)` 中的模式保存到特殊的缓冲区，这种方法可以保存 9 个模式，如：

  `\(That\) or \(this\)` 会将 That 保留到保留缓冲区 1 中，将 this 保存到 2 中，保留的模式可以在之后用 `\1` 到 `\9` 排列，如：`:%s/\(That\) or \(this\)/\2 or \1`，会将 `That or this` 替换为 `this or That`。

  也可以在搜索或替换时使用该表示法，如：`:s/\(abcd\)\1/alphabet-soup/` 来将 `abcdabcd` 替换为 `alphabet-soup`。

- `\< \>` ：会匹配出以某些字符开头（`\<`）或结尾（`\>`）的单词（以标点符号或空格来分隔）。

- `~` ：匹配出任何上一次搜索时是使用的正则表达式。这种方法只能用在**正则搜索**（即使用 `/`）中，而不能用在替换中。

替换字符串中的元字符：

替换字符串会把 `.` 和 `$` 当成一般字符串处理，所以**不需要转义**。但只局限于替换字符串，在搜索时仍需要转义，如 `:%s/1\. Start/2. Next, start with $100/` 中，`1.` 中的点仍需要转义。

- `\n` ：与搜索中的功能类似。
- `\` ：转义字符。
- `&` ：在替换字符串中，会被替换为搜索模式匹配出的完整文本，如：`:%s/Yazstremski/&, Carl` 中的替换字符串为 `Yazstremski, Carl`；也可以用来替换可变模式，如：`:1,10s/.*/(&)/` 可以用来给 1 到 10 行的内容加上括号。
- `~` ：与搜索模式类似，代表上一个替换字符串，如：`:s/thier/their/`用来将一行中的第一个 `thier` 替换为 `their`，而 `:s/tiher/~/` 会将第一个 `tiher` 替换为 `their`。
- `\u`、`\l` ：使替换字符串中的下一个字符变成大写或小写。如，要将当前文件中所有的 `That or this` 改为 `This or that`，结合前面的例子，我们可以用 `:%s/\(That\) or \(this\)/\u\2 or \l\1/`。
- `\U` 或 `\L` 与 `\E` 或 `\e` ：大写的 U 和 L 会在遇到 `\e` 或 `\E` 将其后的所有字符都替换为大写或小写，如，要将 `Python`替换为 `PYTHON` 可以：`:s/Python/\U&`。

> 所有的模式都是大小写敏感的，当然，可以用 `[ ]` 来同时选定大小写。、

其他技巧：

- `&` 可以作为 vi 命令，可以加上范围和模式，如：在将上一行的 `Python` 替换为 `PYTHON` 后，可以用 `:n,.+x&g` 将从第 n 行到第 n + x 行的 `Python` 替换为 `PYTHON`。
- `:~` 与 `:&` 类似，但 `&` 专指上一个替换命令的模式，而 `~` 是任何命令中使用的模式（不一定是上一个替换）。
- 除了 `/`，分隔字符还可以是除 `\`、`"`、`|` 外的任何字符，这在替换地址时很方便：`:%s;/usr1/tim;/home/tim;g`。

## 在 Ex / Vi 中执行 Unix 命令

可以用 `ex` 模式划定范围后作为输入传递给 `unix` 命令过滤：

```
:1,4!sort
```

上面的命令会将第一行到第四行的作为输入传递给 `sort`，再将排序好的结果替换传入的结果。

也可以用 `vi/vim` 模式的移动指令将输入传递给 `unix` 命令过滤：

```
!4jsort
```

可以达到和上面一样的效果。`vi/vim` 模式的语法为：

```
!{motion}{unix command}
```

可以用两个 `!` 来默认指定当前行：

```
!!command
```

如果想重复上一条指令，可以用如下语法：

```
!{motion}!
```

## 保存命令

### 缩写

在 vi 中，可以定义缩写，在插入模式下自动展开为原文：

```
:ab abbr phrase
```

- 其中，`abbr` 是由我们指定的 `phrase` 的缩写，`ab` 是 abbreviate 的缩写。

可以用 `:ab` 来列出当前的缩写，用 `:unab abbr` 来取消指定的缩写。

> 在 vi 中，结尾递归不被允许，而文中递归可以使用，但不会被展开；在 vim 中，结尾递归和文中递归都可以使用，但都不会被展开。

### 按键映射

在映射按键时，`vi` 不希望在命令模式下使用以下按键来定义命令：

- `g`、`K`、`q`、`V`、`v`、`^A`、`^K`、`^O`、`^W`、`^X`、`_`、`*`、`\`、`=`

> 在 vim 中，可以使用 `^K`、`^_` 和 `\`。

你当然可以用自定义映射覆盖已有的按键，但你会失去该按键的默认功能，除非你真的知道自己在干什么，否则不要这样。

vim 中默认的 leader 键是 `\`。

有些特殊的键如 `ENTER` `ESC` `BACKSPACE` `DELETE` 在 ex 的命令模式中已经有定义，无法正常输入它们，如果将其作为按键映射的一部分，需要在前面加上 `CTRL-V`。

> `CTRL-V` 会被显示为 `^` 字符，但这并不意味着你可以输入 `^` 来代替 `CTRL-V`。跟在 `CTRL-V` 后的一般字符通常都有其他含义，如：`^M` 代表换行，`^[`代表转义，`^H`代表退格。

如果要将控制字符作为映射的命令，通常只需正常输入即可，如 `CTRL-A`。但对于 `CTRL-T` `CTRL-W` `CTRL-X`，必须在映射时用 `CTRL-V` 来转义。这种方法可以用在任何 ex 命令上，比如在缩写或替换中。

**不能在插入模式的映射中使用 `|`。**

通常我们不会在插入模式中映射按键，但是可以通过在 `map` 后加 `!` 来强制覆盖按键原来的含义从而产生新的行为，取消映射时也需要使用 `!`。

### 宏

还可以创建宏来执行复杂的指令序列。在传统的 `ex` 和 `vi`中，需要先在文本中输入一行命令，然后将其删除（保存在某一个缓冲区中，再用 `@` 命令执行缓冲区的内容，如：

```
cwgadfly CTRL-V ESC
```

然后按 `ESC` 退出插入模式，执行 `"gdd"` 删除这一行并将其内容保存在缓冲区 `g` 中，按 `@g` 能够执行这个宏。由于 `@` 会被解释为 vi 命令，所以可以用 `.` 来重复执行宏，也可以用 `@@` 来重复执行上一次执行的宏。

vim 提供了更简单的方法来定义宏，只需要按`q` + `寄存器名`，vim 就会录制接下来的操作并保存到寄存器中，直到按 `q` 停止录制为止。

## 程序员相关的设置

### 缩进

在设置了自动缩进（`autoindent`）的输入模式下，`CTRL-T` 会给程序加一级缩进，`CTRL-D` 会减一级缩进。并且，在输入 `^ CTRL-D `时，光标会回到这一行的开头，该行之后的行仍然按照原有缩进进行自动缩进；而 `0 CTRL-D` 则会将缩进值归零，进入下一行时不会自动缩进。

> `^` 在这里就是`shift + 6`，而不是前文中的 `CTRL-V`。

可以用 `<<` 和 `>>` 来移动当前行的代码，它们分别会将当前行向左/右移动 8 个空格，移动的长度可以通过 `shiftwidth` 来自定义，我们通常将其设定为与制表符 `tab` 的值相同。制表符的长度可以通过修改 `tapstop` 来指定，也可以通过设置 `expandtab` 的值从而使 `tab` 被替换为对应数量的空格。

可以用 `set list` 来展示当前的缩进状态，如将 `tab` 显示为 `^I`，用 `$` 来标识行尾。也可以用`:l` 来临时显示，如：`:5,20 l`。

### 寻找与标签

在寻找括号时，可以设置 `showmatch`，当输入 `)`、`]` 或 `}` 时，光标会先移动到对应的开括号处，再回到当前的位置，如果不存在则会提示。

可以用 `CTRL+]` 来跳转到当前光标下的标识符对应的标签上。

**对于标签，现在更推荐使用 [universal ctags](https://ctags.io) 搭配 [vim-gutentags](https://github.com/ludovicchabant/vim-gutentags) 来自动生成标签。** 你也可以使用更复杂的 gtags，但是我更推荐使用 LSP，只保留 ctags 做基本的支持。
